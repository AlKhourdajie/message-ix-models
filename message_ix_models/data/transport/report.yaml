# Reporting configuration for MESSAGEix-Transport
#
# This file only contains a subset of computations, mostly related to
# IAMC-format tables, that can be specified in this static YAML format. For the
# rest, see message_data.model.transport.report.

MESSAGEix-Transport:
  filter: False

general:
# Configuration for :func:`check`. Adds a single key, 'transport check', that
# depends on others and returns a :class:`pandas.Series` of :class:`bool`.
- key: transport check
  comp: transport_check
  inputs: [ scenario, ACT:nl-t-yv-va-m-h ]

# Exogenous data
- key: distance:nl-driver_type:ldv
  comp: distance_ldv
  inputs: [ config ]
- key: distance:nl:non-ldv
  comp: distance_nonldv
  inputs: [ config ]

# Demand per capita
- key: demand:*:capita
  comp: ratio
  inputs: [ demand:n-c-y, population:n-y ]

# Vehicle stocks
- key: CAP:*:non-ldv+units
  comp: apply_units
  inputs: [ CAP:nl-t-ya:non-ldv ]
  # FIXME should not need the extra [vehicle] in the numerator
  args: {units: "v**2 Tm / a"}

- key: stock:*:non-ldv
  comp: ratio
  inputs: [ CAP:nl-t-ya:non-ldv+units, distance:nl:non-ldv ]
  sums: true

- key: CAP:*:ldv+units
  comp: apply_units
  inputs: [ CAP:nl-t-ya:ldv ]
  args: {units: "v ** 2 Tm / a"}


- key: stock:*:ldv
  comp: ratio
  inputs: [ CAP:nl-t-ya:ldv+units, distance:nl-driver_type:ldv ]
  sums: true

# NB these units are correct for final energy only
- key: in:*:transport+units
  comp: apply_units
  inputs: [ in::transport ]
  args: {units: "GWa / a"}
  sums: true

- key: in:*:ldv+units
  comp: apply_units
  inputs: [ in::ldv ]
  args: {units: "GWa / a"}
  sums: true

- key: out:*:transport+units
  comp: apply_units
  inputs: [ out::transport ]
  args: {units: "Tm / a"}
  sums: true

# Units of ACT are not carried, so must correct here:
# - Add [time]: -1
# - Remove [vehicle]: -1, [distance]: -1
#
# When run together with global.yaml reporting, emi:* is assigned units
# of "Mt / year". Using apply_units() causes these to be *converted* to
# kt/a, i.e. increasing the magnitude; so use assign_units() instead.
- key: emi:*:transport+units
  comp: assign_units
  inputs: [ emi::transport ]
  args: {units: "kt / a"}
  sums: true

# Concatenate IAMC-format tables
- key: transport iamc
  comp: concat
  inputs:
  - _transport 0a::iamc
  - _transport 0b::iamc
  - _transport 0c::iamc
  - _transport 0d::iamc
  - _transport 1::iamc
  - _transport 2a::iamc
  - _transport 2b::iamc
  - _transport 2c::iamc
  - _transport 2d::iamc
  - _transport 2e::iamc
  # Temporarily disabled to merge #370
  # - _transport 3a::iamc
  - _transport 3b::iamc
  - _transport 3c::iamc
  # For debugging
  # - _transport debug ACT::iamc
  # - _transport debug CAP::iamc
  # - _transport debug CAP_NEW::iamc

# Path and comp for IAMC output to file
- key: transport CSV path
  comp: make_output_path
  inputs: [ config ]
  args: { name: transport.csv }
- key: transport XLSX path
  comp: make_output_path
  inputs: [ config ]
  args: { name: transport.xlsx }
- key: transport iamc CSV
  comp: write_report
  inputs: [ transport iamc, transport CSV path ]
- key: transport iamc XLSX
  comp: write_report
  inputs: [ transport iamc, transport XLSX path ]
- key: transport iamc file
  comp: null
  inputs: [ transport iamc CSV, transport iamc XLSX ]

# Store IAMC data on scenario
- key: transport iamc store
  comp: store_ts
  inputs: [ scenario, transport iamc ]

# Collecting all others
- key: transport iamc all
  comp: null
  inputs: [ transport iamc file, transport iamc store ]
- key: transport all
  comp: null
  inputs:
  # - transport plots
  - transport iamc all

# Groups of keys for re-use
_iamc formats:
  # Units for final energy. This *exact* value (and not e.g. "EJ / year") is required
  # for the legacy reporting to properly handle the result.
  fe_unit: &fe_unit
    unit: EJ/yr
  emi_unit: &emi_unit
    unit: Mt/yr

# NB these are currently tailored to produce the variable names expected for the
#    NGFS project
iamc:
# Activity
- variable: _transport 0a
  base: out:nl-t-ya-c:transport+units
  var: [ "Energy Service|Transportation", t, c ]

- variable: _transport 0b
  base: out:nl-ya-c:transport+units
  var: [ "Energy Service|Transportation", c ]

- variable: _transport 0c
  base: out:nl-t-ya:transport+units
  var: [ "Energy Service|Transportation", t ]

- variable: _transport 0d
  base: out:nl-ya:transport+units
  var: [ "Energy Service|Transportation" ]

# Stock
- variable: _transport 1
  base: stock:nl-t-ya:ldv
  var: [ "Transport|Stock|Road|Passenger|LDV", t ]
  unit: Mvehicle

# Final energy

# The following are 4 different partial sums of in::transport, in which
# individual technologies are already aggregated to modes
- variable: _transport 2a
  base: in:nl-t-ya-c:transport+units
  var: [ "Final Energy|Transportation", t, c ]
  <<: *fe_unit

- variable: _transport 2b
  base: in:nl-ya-c:transport+units
  var: [ "Final Energy|Transportation", c ]
  <<: *fe_unit

- variable: _transport 2c
  base: in:nl-t-ya:transport+units
  var: [ "Final Energy|Transportation", t ]
  <<: *fe_unit

- variable: _transport 2d
  base: in:nl-ya:transport+units
  var: [ "Final Energy|Transportation" ]
  <<: *fe_unit

- variable: _transport 2e
  base: in:nl-t-ya-c:ldv+units
  var: [ "Final Energy|Transportation|Road|Passenger|LDV", t, c ]
  <<: *fe_unit

# Emissions using MESSAGEix emission_factor parameter
- variable: _transport 3a
  # Auto-sum over dimensions yv, m, h
  base: emi:nl-t-ya-e-gwp metric-e equivalent:gwpe+agg
  # Same as in data/report/global.yaml
  var: [ "Emissions|CO2|Energy|Demand|Transportation", t, e, e equivalent, gwp metric ]

- variable: _transport 3b
  base: emi:nl-t-ya-e:transport+units
  var: [ "Emissions", e, "Energy|Demand|Transportation", t]
  <<: *emi_unit

- variable: _transport 3c
  base: emi:nl-ya-e:transport+units
  var: [ "Emissions", e, "Energy|Demand|Transportation"]
  <<: *emi_unit

# For debugging
- variable: _transport debug ACT
  base: ACT:nl-t-ya
  var: [ "(debug) ACT:nl-t-ya", t ]

- variable: _transport debug CAP
  base: CAP:nl-t-ya
  var: [ "(debug) CAP:nl-t-ya", t ]

- variable: _transport debug CAP_NEW
  base: CAP_NEW:nl-t-yv
  var: [ "(debug) CAP_NEW:nl-t-yv", t ]
